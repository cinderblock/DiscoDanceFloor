#!/usr/bin/env node

'use strict';

var SerialPort = require('serialport').SerialPort;
var optimist = require('../node_modules/serialport/node_modules/optimist');
var comm = require('../lib/comm.js');

var args = optimist
  .alias('h', 'help')
  .alias('h', '?')
  .options('portname', {
    alias: 'p',
    describe: 'Name of serial port. See serialPortList.js for open serial ports.'
  })
  .argv;

if (args.help) {
  optimist.showHelp();
  return process.exit(-1);
}

if (!args.portname) {
  console.error('Serial port name is required.');
  return process.exit(-1);
}

process.stdin.resume();
process.stdin.setRawMode(true);
process.stdin.on('data', function (s) {
  if (s[0] === 0x03) {
    port.close();
    process.exit(0);
  }
});

var port = comm.start(args.portname);
port.on('error', function (err) {
  console.log(err);
});
